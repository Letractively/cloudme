<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Loclist</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
<link rel="apple-touch-startup-image" href="/apple-touch-startup-image.png"/>
<link rel="stylesheet" href="/css/style.css" type="text/css" />
<script type="text/javascript" src="/js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="/js/simple-confirm-0.1.js"></script>
<script type="text/javascript">
(function($) {
  var hasChanged = false;

  function doSubmit(form) {
    if (hasChanged) {
      var url = $(form).attr('action') + '?';
      $(form).find('input').each(function(index, child) {
        var value = encodeURI($(child).attr('value'));
        var name = $(child).attr('name');
        url = url + name + '=' + value;
      });
      index(url);
      hasChanged = false;
    }
    return false;
  }

  $.fn.asyncSubmit = function() {
    var name = $(this).attr('name');
    var form = $(this).closest('form');
    $(this).change(function() { hasChanged = true; });
    $(this).blur(function() { doSubmit(form); });
    $(form).submit(function() { return doSubmit(form); });
  };
})(jQuery);

var itemListId;

function edit() {
  var url = '/action/item/' + itemListId;
  $('body').load(url, function() {
    $('#buttonRight a').click(function() { show(itemListId); });
    $('a.delete').click(function() {
      index($(this).attr('href'));
      return false;
    });
  });
}

function show(id) {
  itemListId = id; 
  navigator.geolocation.getCurrentPosition(function(position) {
    var latitude = position.coords.latitude; 
    var longitude = position.coords.longitude;
    var url = '/action/checkin/' + itemListId + '/' + latitude + '/' + longitude;
    $('body').load(url, function() {
      $('#buttonLeft a').click(function() { index(); });
      $('#buttonRight a').click(function() { edit(); });
    });
  }, function() {
      alert(error);
  });
}

function index(url) {
  $('body').load(url == null ? '/action/list' : url, function() {
    $('a.checkin').click(function() {
      show($(this).attr('id'));
    });
    $('input').asyncSubmit();
  });
}

$(document).ready(function() {
  window.scrollTo(0, 1);
  index();
});
</script>
</head>
<body>
</body>
</html>
