<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Lists</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
<link rel="apple-touch-startup-image" href="/apple-touch-startup-image.png"/>
<link rel="stylesheet" href="/css/style.css" type="text/css" />
<script type="text/javascript" src="/js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="/js/jquery.touchwipe.js"></script>
<script type="text/javascript" src="/js/sugar.js"></script>
<script type="text/javascript">
var itemListId;

function edit(url) {
  $('body').load(url == null ? '/action/edit/' + itemListId : url, function() {
    $('#buttonRight a').click(function() { checkin(itemListId); });
    $('.roundedRectangle a.delete').click(function() {
      var title = $(this).attr('title');
      var url = $(this).attr('href');
      if (confirm(title)) { index(url); }
      return false;
    });
    $('.edgeToEdge input').each(function() {
      var e = $(this).closest('li'); 
      $(this).asyncSubmit(function(url) { 
        $.get(url);
        if (e.hasClass('add')) {
          e.removeClass('add');
          e.addClass('remove');
        }
      }) 
    });
    $('.roundedRectangle input').asyncSubmit(function(url) {
      edit(url); 
    });
    $('.edgeToEdge a.toggle').click(function() {
      var id = $(this).attr('id');
      var e = $(this).closest('li');
      var url = '/action/edit/' + itemListId + '/' + (e.hasClass('add') ? 'add' : 'remove') + '/' + id;
      $.get(url);
      if (e.hasClass('remove')) {
        e.find('input').val('');
      }
      e.toggleClass('add');
      e.toggleClass('remove');
      return false;
    });
    $('.edgeToEdge a').touchwipe({
      wipeLeft: function(source) { $(source).closest('li').find('a.delete').toggle(); },
      wipeRight: function(source) { $(source).closest('li').find('a.delete').toggle(); },
      min_move_x: 150,
      preventDefaultEvents: false
    });
    $('.edgeToEdge a.delete').click(function() {
      $(this).closest('li').hide();
      $.get($(this).attr('href'));
      return false;
    });
  });
}



// --------------------------------------
var undefined;
var checkinLink = undefined;

function checkin(event) {
  event.preventDefault();
  if (checkinLink == undefined) {
    event.stopImmediatePropagation();
    checkinLink = this;
    navigator.geolocation.getCurrentPosition(function(position) {
      var latitude = position.coords.latitude; 
      var longitude = position.coords.longitude;
      var position = latitude + '/' + longitude;
      var url = $(checkinLink).attr('href') + position;
      $(checkinLink).attr('href', url);
      $(checkinLink).click();
    }, function(error) {
      alert(error);
    });
  }
  else {
    checkinLink = undefined;
  }
}

function switchAction(a, oldAction, newAction) {
  var li = $(a).closest('li');
  if (li.hasClass(oldAction)) {
    li.removeClass(oldAction);
    li.addClass(newAction);
    var href = $(a).attr('href');
    $(a).attr('href', href.replace(oldAction, newAction));
  }
}

function clearAttribute(a) {
  $(a).closest('li').find('input.attribute').val('');  
}

function attributeChange() {
  var oldAction = 'add';
  var newAction = 'remove';
  var li = $(this).closest('li');
  if (li.hasClass(oldAction)) {
    li.removeClass(oldAction);
    li.addClass(newAction);
    var a = li.find('a.edit');
    var href = a.attr('href');
    a.attr('href', href.replace(oldAction, newAction));
  }
}

$(function() {
  $('body').sugar({ 
    url : '/action/index',
    onPreLoad : function() {
        $('a.checkin').click(checkin);
      },
    onPostLoad : function() {
        $('li.add a.edit').click(function() { switchAction(this, 'add', 'remove'); });
        $('li.remove a.edit').click(function() { switchAction(this, 'remove', 'add'); clearAttribute(this); });
        $('input.attribute').change(attributeChange);
      }
  });
});
</script>
</head>
<body>
</body>
</html>
