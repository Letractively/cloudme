<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Lists</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
<link rel="apple-touch-startup-image" href="/apple-touch-startup-image.png"/>
<link rel="stylesheet" href="/css/style.css" type="text/css" />
<script type="text/javascript" src="/js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="/js/jquery.touchwipe.js"></script>
<script type="text/javascript" src="/js/simple-confirm-0.1.js"></script>
<script type="text/javascript">
(function($) {
  var hasChanged = false;

  function doSubmit(form, callback) {
    if (hasChanged) {
      var url = $(form).attr('action') + '?';
      $(form).find('input').each(function(index, child) {
        var value = encodeURI($(child).attr('value'));
        var name = $(child).attr('name');
        url = url + name + '=' + value + '&';
      });
      callback(url);
      hasChanged = false;
    }
    return false;
  }

  $.fn.asyncSubmit = function(callback) {
    var name = $(this).attr('name');
    var form = $(this).closest('form');
    $(this).change(function() { hasChanged = true; });
    $(this).blur(function() { doSubmit(form, callback); });
    $(form).submit(function() { return doSubmit(form, callback); });
  };
})(jQuery);

var itemListId;

function edit(url) {
  $('body').load(url == null ? '/action/edit/' + itemListId : url, function() {
    $('#buttonRight a').click(function() { checkin(itemListId); });
    $('.roundedRectangle a.delete').click(function() {
      var title = $(this).attr('title');
      var url = $(this).attr('href');
      if (confirm(title)) { index(url); }
      return false;
    });
    $('.edgeToEdge input').each(function() {
      var e = $(this).closest('li'); 
      $(this).asyncSubmit(function(url) { 
        $.get(url);
        if (e.hasClass('add')) {
          e.removeClass('add');
          e.addClass('remove');
        }
      }) 
    });
    $('.roundedRectangle input').asyncSubmit(function(url) {
      edit(url); 
    });
    $('.edgeToEdge a.toggle').click(function() {
      var id = $(this).attr('id');
      var e = $(this).closest('li');
      var url = '/action/edit/' + itemListId + '/' + (e.hasClass('add') ? 'add' : 'remove') + '/' + id;
      $.get(url);
      if (e.hasClass('remove')) {
        e.find('input').val('');
      }
      e.toggleClass('add');
      e.toggleClass('remove');
      return false;
    });
    $('.edgeToEdge a').touchwipe({
      wipeLeft: function(source) { $(source).closest('li').find('a.delete').toggle(); },
      wipeRight: function(source) { $(source).closest('li').find('a.delete').toggle(); },
      min_move_x: 150,
      preventDefaultEvents: false
    });
    $('.edgeToEdge a.delete').click(function() {
      $(this).closest('li').hide();
      $.get($(this).attr('href'));
      return false;
    });
  });
}

function checkin(id) {
  itemListId = id; 
  navigator.geolocation.getCurrentPosition(function(position) {
    var latitude = position.coords.latitude; 
    var longitude = position.coords.longitude;
    var url = '/action/list/checkin/' + itemListId + '/' + latitude + '/' + longitude;
    $('body').load(url, function() {
      $('#buttonLeft a').click(function() { index(); });
      $('#buttonRight a').click(function() { edit(); });
    });
  }, function() {
      alert(error);
  });
}

function index(url) {
  $('body').load(url == null ? '/action/index' : url, function() {
    $('a.checkin').click(function() { checkin($(this).attr('id')); });
    $('input').asyncSubmit(index);
  });
}

// --------------------------------------
(function($) {
  var element;

  $.fn.sugar = function(args) {
    element = $(this);
    function load(url) {
      if (url == null) { url = $(this).attr('href'); }
      if (url.substr(0, 1) === '!') {
        $.get(url);
      }
      else {
        element.load(url, function() {
          $('a').click(load);
        });
      }
      return false;
    }
    load(args.url);
  };

})(jQuery);


$(function() {
  $('body').sugar({ url: '/action/index' });
});
</script>
</head>
<body>
</body>
</html>
