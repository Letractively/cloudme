<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Lists</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
<link rel="apple-touch-startup-image" href="/apple-touch-startup-image.png"/>
<link rel="stylesheet" href="/css/style.css" type="text/css" />
<script type="text/javascript" src="/js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="/js/jquery.touchwipe.js"></script>
<script type="text/javascript" src="/js/sugar.js"></script>
<script type="text/javascript">
var noteId;

function edit(url) {
  $('body').load(url == null ? '/action/edit/' + noteId : url, function() {
    $('#buttonRight a').click(function() { checkin(noteId); });
    $('.roundedRectangle a.delete').click(function() {
      var title = $(this).attr('title');
      var url = $(this).attr('href');
      if (confirm(title)) { index(url); }
      return false;
    });
    $('.edgeToEdge input').each(function() {
      var e = $(this).closest('li'); 
      $(this).asyncSubmit(function(url) { 
        $.get(url);
        if (e.hasClass('add')) {
          e.removeClass('add');
          e.addClass('remove');
        }
      }) 
    });
    $('.roundedRectangle input').asyncSubmit(function(url) {
      edit(url); 
    });
    $('.edgeToEdge a.toggle').click(function() {
      var id = $(this).attr('id');
      var e = $(this).closest('li');
      var url = '/action/edit/' + noteId + '/' + (e.hasClass('add') ? 'add' : 'remove') + '/' + id;
      $.get(url);
      if (e.hasClass('remove')) {
        e.find('input').val('');
      }
      e.toggleClass('add');
      e.toggleClass('remove');
      return false;
    });
    $('.edgeToEdge a').touchwipe({
      wipeLeft: function(source) { $(source).closest('li').find('a.delete').toggle(); },
      wipeRight: function(source) { $(source).closest('li').find('a.delete').toggle(); },
      min_move_x: 150,
      preventDefaultEvents: false
    });
    $('.edgeToEdge a.delete').click(function() {
      $(this).closest('li').hide();
      $.get($(this).attr('href'));
      return false;
    });
  });
}



// --------------------------------------
var undefined;
var checkinLink = undefined;

function checkin(event) {
  event.preventDefault();
  if (checkinLink == undefined) {
    event.stopImmediatePropagation();
    checkinLink = this;
    navigator.geolocation.getCurrentPosition(function(position) {
      var latitude = position.coords.latitude; 
      var longitude = position.coords.longitude;
      var position = latitude + '/' + longitude;
      var url = $(checkinLink).attr('href') + position;
      $(checkinLink).attr('href', url);
      $(checkinLink).click();
    }, function(error) {
//      alert(error);
      var position = '0/0';
      var url = $(checkinLink).attr('href') + position;
      $(checkinLink).attr('href', url);
      $(checkinLink).click();
    });
  }
  else {
    checkinLink = undefined;
  }
}

function changeAttribute() {
  var li = $(this).closest('li');
  var a = li.find('a.edit');
  if (!a.hasClass('inNote')) {
    a.addClass('inNote');
  }
}

function tickItem(event) {
  if ($(this).hasClass('ticked')) {
    event.preventDefault();
    return;
  }
  $(this).addClass('ticked'); 
  $(this).removeClass('unticked'); 
}

function toggleInNote() {
  $(this).toggleClass('inNote'); 
  $(this).closest('li').find('input.attribute').val('');  
}

$(function() {
  $('body').sugar({ 
    url : '/action/index',
    onLoad : function() {
        $('a.checkin').click(checkin);
        $('a.unticked').click(tickItem);
        $('a.edit').click(toggleInNote);
        $('input.attribute').change(changeAttribute);
        $('a.edit').touchwipe({
          wipeLeft: function(source) { $(source).closest('li').find('a.delete').toggle(); },
          wipeRight: function(source) { $(source).closest('li').find('a.delete').toggle(); },
          min_move_x: 150,
          preventDefaultEvents: false
        });
      },
  });
});
</script>
</head>
<body>
</body>
</html>
